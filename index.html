<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Formulario iD Myself – HOYALUX</title>

<style>
/* ===== A4 y reset impresión ===== */
@page { size: A4; margin: 12mm }
html,body{height:100%}
body{
  margin:0;
  background:#eef2ff;
  font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

/* ===== Paleta ===== */
:root{
  --hoya-navy:#0b3d91;
  --hoya-navy-ink:#0a2d6f;
  --ink:#0f172a;
  --muted:#475569;
  --rose:#f7ecf5;
  --rose-border:#ead7e7;
  --accent:#7a2b6c;
}

/* ===== Barra superior ===== */
.toolbar{ position:sticky; top:0; z-index:20; background:var(--hoya-navy); padding:10px; box-shadow:0 6px 16px rgba(2,6,23,.18) }
.toolbar-inner{ max-width:210mm; margin:0 auto; display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap }
.btn{
  background:#fff; color:var(--hoya-navy);
  border:0; padding:10px 16px; border-radius:10px;
  font-weight:800; cursor:pointer;
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn-secondary{
  background:transparent;
  color:#ffffff;
  border:2px solid #ffffff;
  padding:8px 14px;
  border-radius:10px;
  font-weight:800;
}
.order-wrap{ display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.1); padding:6px 10px; border-radius:10px }
.order-label{ color:#fff; font-weight:700; font-size:12px; letter-spacing:.2px }
.order-box{
  background:#fff; color:#0a2d6f; border-radius:8px; padding:6px 10px; font-weight:800;
  min-width:150px; text-align:center; border:2px solid #fff; box-shadow:0 1px 0 rgba(0,0,0,.05)
}
.order-box.ok{ background:#10b981; color:#fff; border-color:#10b981 }
.order-status{ color:#e2fbe8; font-weight:700; font-size:12px; display:none }
.order-status.show{ display:inline-flex; align-items:center; gap:6px }
.order-status::before{ content:"✓"; font-weight:800 }

/* ===== Hoja ===== */
.sheet{ width:210mm; margin:0 auto; }
.page{
  background:#fff;
  box-shadow:0 10px 28px rgba(15,23,42,.15);
  margin:10mm 0;
  padding:0;
}

/* ===== Hero ===== */
.hero{
  position:relative;
  width:210mm;
  height:73mm;
  margin:0 auto;
  background:#ddd url('idmyself_header.jpg') center/cover no-repeat;
}
.hero .band{
  position:absolute; left:0; right:0; bottom:8mm;
  display:flex; justify-content:center;
}
.hero .title{
  background:var(--hoya-navy);
  color:#fff; font-weight:900; letter-spacing:.04em;
  padding:10px 20px; border-radius:8px;
  box-shadow:0 10px 22px rgba(2,6,23,.25);
}

/* ===== Secciones ===== */
.section{ padding:10mm 12mm 6mm }
.section h3{
  margin:0 0 6mm; color:#6d1c5e; letter-spacing:.2px;
  font-size:13.5px; display:flex; align-items:center; gap:8px;
}
.section h3::before{ content:""; width:12px; height:12px; border-radius:3px; background:var(--hoya-navy) }

/* ===== Panel azul (información personal) ===== */
.personal{
  background:var(--hoya-navy); color:#e6eefc;
  border-radius:10px; padding:10mm 12mm;
  --g:22px; background-image:
    linear-gradient(rgba(255,255,255,.08) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.08) 1px, transparent 1px);
  background-size:var(--g) var(--g), var(--g) var(--g);
}
.personal h3{color:#fff}
.personal h3::before{background:#fff}
.personal label{color:#e6eefc}
.grid{display:grid; gap:10px 14px}
.col-6{grid-column:span 6}
.col-4{grid-column:span 4}
.col-8{grid-column:span 8}

/* ===== Inputs ===== */
.input, .line{
  width:100%; height:26px;
  border:none; border-bottom:1.5px solid rgba(255,255,255,.75);
  background:transparent; color:#fff; font:inherit;
}
.input::placeholder, .line::placeholder{ color:#dce7ff }
.radio-row{ display:flex; gap:14px; align-items:center }

/* ===== Caja rosada ===== */
.soft .input, .soft .line{
  background:var(--rose); color:var(--ink);
  border:1px solid var(--rose-border);
  border-radius:6px; height:28px; padding:0 8px;
}
label{font-size:12px; color:var(--muted); display:block}

/* ===== Dos columnas ===== */
.two{display:grid; grid-template-columns: 1fr 1fr; gap:12mm}

/* ===== Chips (radios) ===== */
.chips{display:flex; flex-wrap:wrap; gap:6px}
.chips label{
  border:1px solid #e2e8f0; border-radius:999px;
  padding:4px 10px; font-size:11.5px; color:#111; cursor:pointer
}
.chips input{appearance:none; width:0; height:0; margin:0}
.chips label:has(input:checked){
  background:var(--rose); border-color:#e7cfe0; color:var(--accent);
}

/* ===== Banner intermedio ===== */
.banner{ height:32mm; background:var(--hoya-navy) }
.banner img{ width:100%; height:100%; object-fit:cover; opacity:.9 }

/* ===== Tabla 0–5 ===== */
.table{ border-collapse:collapse; width:100%; font-size:11.5px }
.table th,.table td{ border:1px solid #eef2ff; padding:6px 8px; vertical-align:top }
.table th{ background:#f8fafc; color:#334155; font-weight:800 }

/* ===== Logos pie ===== */
.foot-logos{
  display:flex; justify-content:space-between; align-items:center;
  padding:8mm 12mm 10mm;
}
.foot-logos img{ height:16mm }

/* Salto de página */
.page-break{ page-break-before:always }

/* Impresión */
@media print{
  .toolbar{display:none}
  .page{box-shadow:none; margin:0}
}
</style>
</head>
<body>

<!-- ===== Barra: Nº de orden + botones ===== -->
<div class="toolbar">
  <div class="toolbar-inner">
    <div class="order-wrap">
      <span class="order-label">Nº de orden</span>
      <span id="orderBox" class="order-box">—</span>
      <span id="orderStatus" class="order-status"></span>
    </div>

    <button id="sendPrintBtn" class="btn" onclick="sendAndPrint()">
      Enviar orden a Trimax y Descargar DOC
    </button>

    <button type="button" class="btn-secondary" onclick="newOrder()">
      Generar nueva Orden
    </button>
  </div>
</div>

<form id="hoyaForm" class="sheet">

  <!-- ============ PÁGINA 1 ============ -->
  <section class="page">

    <!-- Hero -->
    <div class="hero">
      <div class="band"><div class="title">FORMULARIO IDENTIFIER · iD MYSELF · HOYALUX</div></div>
    </div>

    <!-- Información personal -->
    <div class="section personal">
      <h3>INFORMACIÓN PERSONAL</h3>
      <div class="grid" style="grid-template-columns: repeat(12, 1fr);">
        <div class="col-6">
          <label>Nombre del cliente</label>
          <input class="line" name="sistema" placeholder="Nombre del cliente" />
        </div>
        <div class="col-6"></div>

        <div class="col-6">
          <label>Nombre</label>
          <input class="line" name="nombre" />
        </div>
        <div class="col-6">
          <label>Apellidos</label>
          <input class="line" name="apellidos" />
        </div>

        <div class="col-4">
          <label>Sexo</label>
          <div class="radio-row">
            <label><input type="radio" name="sexo" value="Masculino"> Masculino</label>
            <label><input type="radio" name="sexo" value="Femenino"> Femenino</label>
          </div>
        </div>
        <div class="col-8">
          <label>Fecha de nacimiento</label>
          <input class="line" name="fecha_nac" type="date" />
        </div>
      </div>
    </div>

    <!-- Prescripción -->
    <div class="section">
      <h3>PRESCRIPCIÓN</h3>
      <div class="two soft">
        <!-- Ojo izquierdo -->
        <div>
          <div style="font-weight:700;color:#7a2b6c;margin-bottom:6px">Ojo izquierdo</div>
          <label>Esférico</label><input class="input" name="esf_oi">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>Cilíndrico</label><input class="input" name="cil_oi"></div>
            <div><label>Eje</label><input class="input" name="eje_oi"></div>
          </div>
          <label>Adición</label><input class="input" name="adic_oi">
          <label>Prisma</label>
          <div class="chips">
            <label><input type="radio" name="prisma_oi" value="Si"> Sí</label>
            <label><input type="radio" name="prisma_oi" value="No"> No</label>
          </div>
        </div>

        <!-- Ojo derecho -->
        <div>
          <div style="font-weight:700;color:#7a2b6c;margin-bottom:6px">Ojo derecho</div>
          <label>Esférico</label><input class="input" name="esf_od">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>Cilíndrico</label><input class="input" name="cil_od"></div>
            <div><label>Eje</label><input class="input" name="eje_od"></div>
          </div>
          <label>Adición</label><input class="input" name="adic_od">
          <label>Primer par de lentes</label>
          <div class="chips">
            <label><input type="radio" name="primer_par" value="Si"> Sí</label>
            <label><input type="radio" name="primer_par" value="No"> No</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Información del prisma -->
    <div class="section">
      <h3>INFORMACIÓN DEL PRISMA</h3>
      <div class="two soft">
        <!-- OI -->
        <div>
          <div style="font-weight:700;color:#7a2b6c;margin-bottom:6px">Ojo izquierdo</div>
          <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end">
            <div><label>Horizontal (valor)</label><input class="input" name="prisma_h_oi_val"></div>
            <label class="chips"><input type="radio" name="horiz_oi" value="Nasal"> Nasal</label>
            <label class="chips"><input type="radio" name="horiz_oi" value="Temporal"> Temporal</label>
          </div>

          <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end;margin-top:6px">
            <div><label>Vertical (valor)</label><input class="input" name="prisma_v_oi_val"></div>
            <label class="chips"><input type="radio" name="vert_oi" value="Nasal"> Nasal</label>
            <label class="chips"><input type="radio" name="vert_oi" value="Temporal"> Temporal</label>
          </div>

          <label style="margin-top:6px">Resultado</label><input class="input" name="prisma_res_oi">
        </div>

        <!-- OD -->
        <div>
          <div style="font-weight:700;color:#7a2b6c;margin-bottom:6px">Ojo derecho</div>
          <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end">
            <div><label>Horizontal (valor)</label><input class="input" name="prisma_h_od_val"></div>
            <label class="chips"><input type="radio" name="horiz_od" value="Nasal"> Nasal</label>
            <label class="chips"><input type="radio" name="horiz_od" value="Temporal"> Temporal</label>
          </div>

          <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end;margin-top:6px">
            <div><label>Vertical (valor)</label><input class="input" name="prisma_v_od_val"></div>
            <label class="chips"><input type="radio" name="vert_od" value="Nasal"> Nasal</label>
            <label class="chips"><input type="radio" name="vert_od" value="Temporal"> Temporal</label>
          </div>

          <label style="margin-top:6px">Resultado</label><input class="input" name="prisma_res_od">
        </div>
      </div>
    </div>

    <!-- Estilo de vida -->
    <div class="section">
      <h3>ESTILO DE VIDA · ¿Dónde pasas el día?</h3>
      <div style="display:grid;grid-template-columns:1fr;gap:10px" class="soft">
        <div>
          <label>Ambientes interiores</label>
          <div class="chips">
            <label><input type="radio" name="int" value="0%">0%</label>
            <label><input type="radio" name="int" value="10%">10%</label>
            <label><input type="radio" name="int" value="20%">20%</label>
            <label><input type="radio" name="int" value="30%">30%</label>
            <label><input type="radio" name="int" value="40%">40%</label>
            <label><input type="radio" name="int" value="50%">50%</label>
            <label><input type="radio" name="int" value="60%">60%</label>
            <label><input type="radio" name="int" value="70%">70%</label>
            <label><input type="radio" name="int" value="80%">80%</label>
            <label><input type="radio" name="int" value="90%">90%</label>
            <label><input type="radio" name="int" value="100%">100%</label>
          </div>
        </div>
        <div>
          <label>Ambientes exteriores</label>
          <div class="chips">
            <label><input type="radio" name="ext" value="0%">0%</label>
            <label><input type="radio" name="ext" value="10%">10%</label>
            <label><input type="radio" name="ext" value="20%">20%</label>
            <label><input type="radio" name="ext" value="30%">30%</label>
            <label><input type="radio" name="ext" value="40%">40%</label>
            <label><input type="radio" name="ext" value="50%">50%</label>
            <label><input type="radio" name="ext" value="60%">60%</label>
            <label><input type="radio" name="ext" value="70%">70%</label>
            <label><input type="radio" name="ext" value="80%">80%</label>
            <label><input type="radio" name="ext" value="90%">90%</label>
            <label><input type="radio" name="ext" value="100%">100%</label>
          </div>
        </div>
      </div>
    </div>

    <div class="banner"><img src="idmyself_actividades.jpg" alt=""></div>

    <div class="foot-logos">
      <img src="Imagen_Hoya.jpg" alt="HOYA">
      <img src="Imagen_tecnologia.jpg" alt="Tecnología japonesa">
    </div>

  </section>

  <!-- ============ PÁGINA 2 ============ -->
  <section class="page page-break">

    <div class="section">
      <h3>CLASIFICACIÓN DE IMPORTANCIA DE CADA ACTIVIDAD · 0 = poco importante, 5 = muy importante</h3>
      <table class="table">
        <thead>
          <tr><th style="width:42%">Actividad</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>Detalles</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Viendo televisión</td>
            <td><input type="radio" name="tv" value="0"></td>
            <td><input type="radio" name="tv" value="1"></td>
            <td><input type="radio" name="tv" value="2"></td>
            <td><input type="radio" name="tv" value="3"></td>
            <td><input type="radio" name="tv" value="4"></td>
            <td><input type="radio" name="tv" value="5"></td>
            <td></td>
          </tr>
          <tr>
            <td>Hacer compras</td>
            <td><input type="radio" name="compras" value="0"></td>
            <td><input type="radio" name="compras" value="1"></td>
            <td><input type="radio" name="compras" value="2"></td>
            <td><input type="radio" name="compras" value="3"></td>
            <td><input type="radio" name="compras" value="4"></td>
            <td><input type="radio" name="compras" value="5"></td>
            <td></td>
          </tr>
          <tr>
            <td>Conducir</td>
            <td><input type="radio" name="drive" value="0"></td>
            <td><input type="radio" name="drive" value="1"></td>
            <td><input type="radio" name="drive" value="2"></td>
            <td><input type="radio" name="drive" value="3"></td>
            <td><input type="radio" name="drive" value="4"></td>
            <td><input type="radio" name="drive" value="5"></td>
            <td>
              <div class="chips">
                <label><input type="checkbox" name="drive_auto"> Auto</label>
                <label><input type="checkbox" name="drive_bus"> Autobús</label>
                <label><input type="checkbox" name="drive_moto"> Moto</label>
                <label><input type="checkbox" name="drive_tren"> Tren</label>
                <label><input type="checkbox" name="drive_camion"> Camión</label>
              </div>
            </td>
          </tr>
          <tr>
            <td>Vida profesional</td>
            <td><input type="radio" name="vida" value="0"></td>
            <td><input type="radio" name="vida" value="1"></td>
            <td><input type="radio" name="vida" value="2"></td>
            <td><input type="radio" name="vida" value="3"></td>
            <td><input type="radio" name="vida" value="4"></td>
            <td><input type="radio" name="vida" value="5"></td>
            <td>
              <div class="chips">
                <label><input type="checkbox" name="work_cerca"> Cerca</label>
                <label><input type="checkbox" name="work_inter_cercano"> Intermedio y cercano</label>
                <label><input type="checkbox" name="work_inter_laboral"> Intermedio laboral</label>
                <label><input type="checkbox" name="work_lejos"> Lejos</label>
                <label><input type="checkbox" name="work_inter_lejano"> Intermedio y lejano</label>
              </div>
            </td>
          </tr>
          <tr>
            <td>Deportes y recreación</td>
            <td><input type="radio" name="sport" value="0"></td>
            <td><input type="radio" name="sport" value="1"></td>
            <td><input type="radio" name="sport" value="2"></td>
            <td><input type="radio" name="sport" value="3"></td>
            <td><input type="radio" name="sport" value="4"></td>
            <td><input type="radio" name="sport" value="5"></td>
            <td>
              <div class="chips">
                <label><input type="checkbox" name="sport_gimnasia"> Gimnasia</label>
                <label><input type="checkbox" name="sport_correr"> Correr y caminar</label>
                <label><input type="checkbox" name="sport_golf"> Golf</label>
                <label><input type="checkbox" name="sport_tenis"> Tenis</label>
                <label><input type="checkbox" name="sport_pelota"> Juegos de pelota</label>
                <label><input type="checkbox" name="sport_ciclismo"> Ciclismo</label>
              </div>
            </td>
          </tr>
          <tr>
            <td>Computadoras y dispositivos digitales</td>
            <td><input type="radio" name="comp" value="0"></td>
            <td><input type="radio" name="comp" value="1"></td>
            <td><input type="radio" name="comp" value="2"></td>
            <td><input type="radio" name="comp" value="3"></td>
            <td><input type="radio" name="comp" value="4"></td>
            <td><input type="radio" name="comp" value="5"></td>
            <td>
              <div class="chips">
                <label><input type="checkbox" name="comp_pc"> Computador</label>
                <label><input type="checkbox" name="comp_portatil"> Computadora portátil</label>
                <label><input type="checkbox" name="comp_varios"> Varios dispositivos</label>
                <label><input type="checkbox" name="comp_tableta"> Tableta</label>
                <label><input type="checkbox" name="comp_phone"> Teléfonos inteligentes</label>
              </div>
            </td>
          </tr>
          <tr>
            <td>Lectura</td>
            <td><input type="radio" name="lect" value="0"></td>
            <td><input type="radio" name="lect" value="1"></td>
            <td><input type="radio" name="lect" value="2"></td>
            <td><input type="radio" name="lect" value="3"></td>
            <td><input type="radio" name="lect" value="4"></td>
            <td><input type="radio" name="lect" value="5"></td>
            <td>
              <div class="chips">
                <label><input type="checkbox" name="lect_libro"> Libro</label>
                <label><input type="checkbox" name="lect_digital"> Dispositivos digitales</label>
                <label><input type="checkbox" name="lect_periodico"> Periódico</label>
                <label><input type="checkbox" name="lect_revista"> Revista</label>
                <label><input type="checkbox" name="lect_varios"> Varios medios</label>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Medidas del marco -->
    <div class="section">
      <h3>MEDIDAS DEL MARCO</h3>
      <div class="two soft">
        <div>
          <div style="font-weight:700;color:#7a2b6c;margin-bottom:6px">Ojo izquierdo / derecho</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div><label>DNP (OI)</label><input class="input" name="dnp_oi"></div>
            <div><label>DNP (OD)</label><input class="input" name="dnp_od"></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
            <div><label>Altura pupilar (OI)</label><input class="input" name="altura_pupilar_oi"></div>
            <div><label>Altura pupilar (OD)</label><input class="input" name="altura_pupilar_od"></div>
          </div>
          <div style="margin-top:6px">
            <label>Altura total del cristalino</label><input class="input" name="altura_total_cristalino">
          </div>
          <div style="margin-top:6px">
            <label>Distancia al vértice</label><input class="input" name="distancia_al_vertice">
          </div>
        </div>
        <div>
          <div><label>Inclinación pantoscópica</label><input class="input" name="inclinacion_pantoscopica"></div>
          <div style="margin-top:6px"><label>Curva del borde</label><input class="input" name="curva_del_borde"></div>
        </div>
      </div>
    </div>

    <!-- Gafas anteriores / Receta previa -->
    <div class="section">
      <h3>GAFAS ANTERIORES</h3>
      <div class="two soft">
        <div>
          <label>Tipo de lente</label><input class="input" name="tipo_lente">
          <label style="margin-top:6px">Proveedor</label>
          <div class="chips">
            <label><input type="radio" name="proveedor" value="HOYA"> HOYA</label>
            <label><input type="radio" name="proveedor" value="Otro"> Otro</label>
          </div>
          <label style="margin-top:6px">Diseño</label><input class="input" name="diseno">
          <label style="margin-top:6px">Longitud del pasillo</label><input class="input" name="longitud_pasillo">
        </div>
        <div>
          <h4 style="margin:0 0 6px;color:#7a2b6c">RECETA PREVIA</h4>
          <div style="font-weight:700;margin:2px 0 6px">Ojo izquierdo</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
            <div><label>Esférico</label><input class="input" name="rp_esf_oi"></div>
            <div><label>Cilíndrico</label><input class="input" name="rp_cil_oi"></div>
            <div><label>Eje</label><input class="input" name="rp_eje_oi"></div>
            <div><label>Adición</label><input class="input" name="rp_adic_oi"></div>
          </div>
          <div style="font-weight:700;margin:10px 0 6px">Ojo derecho</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
            <div><label>Esférico</label><input class="input" name="rp_esf_od"></div>
            <div><label>Cilíndrico</label><input class="input" name="rp_cil_od"></div>
            <div><label>Eje</label><input class="input" name="rp_eje_od"></div>
            <div><label>Adición</label><input class="input" name="rp_adic_od"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Satisfacción -->
    <div class="section">
      <h3>NIVEL DE SATISFACCIÓN</h3>
      <div class="chips">
        <label><input type="radio" name="satisfaccion" value="Muy satisfecho"> Muy satisfecho</label>
        <label><input type="radio" name="satisfaccion" value="Satisfecho"> Satisfecho</label>
        <label><input type="radio" name="satisfaccion" value="Neutral"> Neutral</label>
        <label><input type="radio" name="satisfaccion" value="Insatisfecho"> Insatisfecho</label>
        <label><input type="radio" name="satisfaccion" value="Muy insatisfecho"> Muy insatisfecho</label>
      </div>
    </div>

    <div class="foot-logos">
      <img src="Imagen_Hoya.jpg" alt="HOYA">
      <img src="Imagen_tecnologia.jpg" alt="Tecnología japonesa">
    </div>

  </section>

</form>

<script>
/* ===== URL de tu Apps Script ===== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz8wYVJCHIBZPW2mzkpBkSUdGUzddeNmXcgpZmeTOfHHgiL1WcA1CMHIM8G4CaG5iMGEQ/exec";

/* ===== Claves de almacenamiento ===== */
const ORDER_KEY = "trimax_order_id";
const ORDER_SENT_KEY = "trimax_order_sent";

/* ===== Utilidades de orden ===== */
function genOrderId(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  const y = d.getFullYear();
  const M = pad(d.getMonth()+1);
  const day = pad(d.getDate());
  const h = pad(d.getHours());
  const m = pad(d.getMinutes());
  const s = pad(d.getSeconds());
  const rand = Math.floor(Math.random()*10000).toString().padStart(4,"0");
  return `TRX-${y}${M}${day}-${h}${m}${s}-${rand}`;
}
function getOrCreateOrderId(){
  let id = localStorage.getItem(ORDER_KEY);
  if(!id){ id = genOrderId(); localStorage.setItem(ORDER_KEY, id); }
  return id;
}
function hydrateOrderUI(sent=false){
  const box = document.getElementById("orderBox");
  const status = document.getElementById("orderStatus");
  box.textContent = getOrCreateOrderId();
  if(sent){
    box.classList.add("ok");
    status.textContent = "Orden generada, alguien de Trimax se contactará con usted";
    status.classList.add("show");
  }else{
    box.classList.remove("ok");
    status.textContent = "";
    status.classList.remove("show");
  }
}

/* ===== Inicialización ===== */
document.addEventListener("DOMContentLoaded", () => {
  const alreadySent = localStorage.getItem(ORDER_SENT_KEY) === "true";
  hydrateOrderUI(alreadySent);
});

/* ===== Enviar a Sheets + marcar UI + imprimir ===== */
async function sendAndPrint(){
  const btn = document.getElementById('sendPrintBtn');
  btn.disabled = true;

  try{
    const form = document.getElementById('hoyaForm');
    const fd = new FormData(form);

    // Adjuntar Nº de orden y timestamp
    const orderId = getOrCreateOrderId();
    fd.append('order_id', orderId);
    fd.append('timestamp', new Date().toLocaleString());

    await fetch(WEB_APP_URL, { method:'POST', body:fd, mode:'no-cors' });

    // Marcar UI en verde y guardar estado
    localStorage.setItem(ORDER_SENT_KEY, "true");
    hydrateOrderUI(true);

    setTimeout(() => window.print(), 300);
  }catch(e){
    alert('Error al enviar/imprimir: ' + e.message);
  }finally{
    btn.disabled = false;
  }
}

/* ===== Generar nueva orden: limpia formulario y crea ID nuevo ===== */
function newOrder(){
  // Borrar estado anterior e ID
  localStorage.removeItem(ORDER_SENT_KEY);
  localStorage.removeItem(ORDER_KEY);

  // Forzar creación de nuevo ID y refrescar UI (sin enviado)
  getOrCreateOrderId();
  hydrateOrderUI(false);

  // Limpiar todos los campos del formulario
  const form = document.getElementById('hoyaForm');
  form.reset();

  // Llevar al usuario al inicio y enfocar primer campo
  window.scrollTo({top:0, behavior:'smooth'});
  setTimeout(() => document.querySelector('input[name="sistema"]')?.focus(), 300);
}

/* (Opcional) Si editan el nombre del cliente, renueva Nº de orden automáticamente
document.querySelector('input[name="sistema"]')?.addEventListener('input', ()=>{
  localStorage.removeItem(ORDER_KEY);
  localStorage.removeItem(ORDER_SENT_KEY);
  hydrateOrderUI(false);
});
*/
</script>
</body>
</html>
